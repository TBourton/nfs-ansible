---
- name: Configure Debian NFS media server
  hosts: nfs_servers
  become: true

  pre_tasks:
    - name: Install required packages
      ansible.builtin.apt:
        name:
          - lsb-release
          - util-linux-extra
          - vim
          - nfs-common
          - open-iscsi
          - curl
          - iotop
          - curl
          - cryptsetup
          - ntfs-3g
          - rsync
          - tmux
        state: present
        update_cache: true

    - name: Download Tailscale installation script
      ansible.builtin.get_url:
        url: https://tailscale.com/install.sh
        dest: /tmp/install_tailscale.sh
        mode: '0755'

    - name: Run Tailscale installation script
      ansible.builtin.command: /tmp/install_tailscale.sh
      args:
        creates: /usr/sbin/tailscaled
      register: tailscale_install_result
      changed_when: false

    - name: Enable and start tailscaled
      ansible.builtin.systemd:
        name: tailscaled
        enabled: true
        state: started

    - name: Create nfs root
      ansible.builtin.file:
        path: "{{ nfs_root }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Create disk mount points
      ansible.builtin.file:
        path: "{{ mnt_root }}/{{ item.name }}"
        state: directory
        mode: "0755"
      loop: "{{ disks }}"

    - name: Mount disks by UUID
      ansible.posix.mount:
        path: "{{ mnt_root }}/{{ item.name }}"
        src: "UUID={{ item.uuid }}"
        fstype: ext4
        opts: defaults,nofail,x-systemd.automount"
        state: mounted
      loop: "{{ disks }}"

    - name: Create logical media directories
      ansible.builtin.file:
        path: "{{ nfs_root }}/{{ item.dst }}"
        state: directory
        mode: "{{ item.mode | default('0777') }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop: "{{ logical_dirs }}"

    - name: Link media directories to disks
      ansible.posix.mount:
        src: "{{ mnt_root }}/{{ item.src }}"
        path: "{{ nfs_root }}/{{ item.dst }}"
        opts: bind
        fstype: none
        state: mounted
      loop: "{{ logical_dirs }}"

  roles:
    - geerlingguy.nfs
